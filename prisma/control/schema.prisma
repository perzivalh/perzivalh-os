generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/@prisma/client-control"
}

datasource db {
  provider = "postgresql"
  url      = env("CONTROL_DB_URL")
}

model Tenant {
  id          String          @id @default(cuid())
  name        String
  slug        String          @unique
  plan        String?
  is_active   Boolean         @default(true)
  created_at  DateTime        @default(now())
  databases   TenantDatabase?
  channels    Channel[]
  users       UserControl[]
  branding    Branding?
  odoo_config OdooConfig?
  tenant_bots TenantBot[]
  audits      AuditLogControl[]
}

model TenantDatabase {
  id               String   @id @default(cuid())
  tenant_id        String   @unique
  db_url_encrypted String
  created_at       DateTime @default(now())
  tenant           Tenant   @relation(fields: [tenant_id], references: [id])
}

model Channel {
  id               String   @id @default(cuid())
  tenant_id        String
  provider         String   @default("whatsapp")
  phone_number_id  String   @unique
  display_name     String?
  waba_id          String?
  verify_token     String
  wa_token_encrypted String
  app_secret_encrypted String?
  is_active        Boolean  @default(true)
  is_default       Boolean  @default(false)
  created_at       DateTime @default(now())
  tenant           Tenant   @relation(fields: [tenant_id], references: [id])

  @@index([tenant_id])
  @@index([provider])
}

model UserControl {
  id            String       @id @default(cuid())
  tenant_id     String?
  email         String       @unique
  password_hash String
  role          String       @default("admin")
  is_active     Boolean      @default(true)
  created_at    DateTime     @default(now())
  tenant        Tenant?      @relation(fields: [tenant_id], references: [id])
  audits        AuditLogControl[]

  @@index([tenant_id])
}

model Branding {
  id          String   @id @default(cuid())
  tenant_id   String   @unique
  brand_name  String
  logo_url    String?
  colors      Json?
  timezone    String?
  created_at  DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenant_id], references: [id])
}

model AuditLogControl {
  id         String   @id @default(cuid())
  tenant_id  String?
  user_id    String?
  action     String
  data_json  Json
  created_at DateTime @default(now())
  tenant     Tenant?      @relation(fields: [tenant_id], references: [id])
  user       UserControl? @relation(fields: [user_id], references: [id])

  @@index([tenant_id])
  @@index([user_id])
  @@index([action])
}

model OdooConfig {
  id                 String   @id @default(cuid())
  tenant_id          String   @unique
  base_url           String
  db_name            String
  username           String
  password_encrypted String
  created_at         DateTime @default(now())
  tenant             Tenant   @relation(fields: [tenant_id], references: [id])
}

model TenantBot {
  id         String   @id @default(cuid())
  tenant_id  String
  flow_id    String
  is_active  Boolean  @default(true)
  config     Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  tenant     Tenant   @relation(fields: [tenant_id], references: [id])

  @@unique([tenant_id, flow_id])
  @@index([tenant_id])
}
