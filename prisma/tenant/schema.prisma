generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/@prisma/client-tenant"
}

datasource db {
  provider = "postgresql"
  url      = env("TENANT_DB_URL")
}

enum UserRole {
  admin
  recepcion
  caja
  marketing
  doctor
}

enum ConversationStatus {
  open
  pending
  assigned
  closed
}

enum MessageDirection {
  in
  out
}

enum MessageType {
  text
  interactive
  image
  video
  audio
  location
  template
  unknown
  note
}

enum VerificationMethod {
  phone
  ci
  manual
}

enum CampaignStatus {
  draft
  scheduled
  sending
  sent
  failed
}

enum CampaignMessageStatus {
  queued
  sent
  failed
}

// Template-related enums
enum TemplateStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PAUSED
  DISABLED
}

enum TemplateCategory {
  MARKETING
  UTILITY
  AUTHENTICATION
}

enum VariableSourceType {
  odoo
  db
  static
}

model User {
  id            String     @id @default(cuid())
  name          String
  email         String     @unique
  password_hash String
  role          UserRole   @default(recepcion)
  is_active     Boolean    @default(true)
  created_at    DateTime   @default(now())
  AuditLogTenant      AuditLogTenant[]    @relation("UserAuditLogs")
  Conversation  Conversation[] @relation("AssignedConversations")
  Campaign      Campaign[] @relation("CampaignCreatedBy")
  MetaTemplate  MetaTemplate[] @relation("MetaTemplateCreatedBy")
  AudienceSegment AudienceSegment[] @relation("AudienceCreatedBy")
}

model Conversation {
  id               String              @id @default(cuid())
  wa_id            String
  phone_number_id  String?
  phone_e164       String
  display_name     String?
  status           ConversationStatus  @default(open)
  assigned_user_id String?
  partner_id       Int?
  patient_id       Int?
  verified_at      DateTime?
  verification_method VerificationMethod?
  last_message_at  DateTime?
  primary_tag_id   String?
  created_at       DateTime            @default(now())
  messages         Message[]
  tags             ConversationTag[]
  primary_tag      Tag?                @relation("ConversationPrimaryTag", fields: [primary_tag_id], references: [id])
  assigned_user    User?               @relation("AssignedConversations", fields: [assigned_user_id], references: [id])
  campaign_messages CampaignMessage[]

  @@index([status])
  @@index([assigned_user_id])
  @@index([last_message_at])
  @@index([partner_id])
  @@index([phone_number_id])
  @@unique([wa_id, phone_number_id])
}

model Message {
  id              String           @id @default(cuid())
  conversation_id String
  direction       MessageDirection
  type            MessageType
  text            String?
  raw_json        Json
  created_at      DateTime         @default(now())
  conversation    Conversation     @relation(fields: [conversation_id], references: [id])

  @@index([conversation_id, created_at])
  @@index([conversation_id, created_at(sort: Desc)], map: "message_conversation_id_created_at_desc_idx")
}

model Tag {
  id    String            @id @default(cuid())
  name  String            @unique
  color String?
  tags  ConversationTag[]
  primary_conversations Conversation[] @relation("ConversationPrimaryTag")
  audience_tags AudienceTag[]
}

model ConversationTag {
  conversation_id String
  tag_id          String
  created_at      DateTime     @default(now())
  conversation    Conversation @relation(fields: [conversation_id], references: [id])
  tag             Tag          @relation(fields: [tag_id], references: [id])

  @@id([conversation_id, tag_id])
}

model Settings {
  id                 Int      @id @default(1)
  bot_enabled        Boolean  @default(true)
  auto_reply_enabled Boolean  @default(true)
  updated_at         DateTime @updatedAt
}

model Session {
  id                    String   @id @default(cuid())
  wa_id                 String
  phone_number_id       String?
  state                 String
  data                  Json
  flow_id               String?
  inactivity_notice_at  DateTime?
  next_due_at           DateTime?
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@unique([wa_id, phone_number_id])
  @@index([flow_id])
  @@index([next_due_at])
  @@index([updated_at])
}

model AuditLogTenant {
  id        String   @id @default(cuid())
  user_id   String?
  action    String
  data_json Json
  created_at DateTime @default(now())
  user      User?    @relation("UserAuditLogs", fields: [user_id], references: [id])

  @@map("AuditLog")
}

model RolePermission {
  id               String   @id @default(cuid())
  role             UserRole @unique
  permissions_json Json
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
}

model Branch {
  id         String   @id @default(cuid())
  code       String   @unique
  name       String
  address    String
  lat        Float
  lng        Float
  hours_text String
  phone      String?
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  services   ServiceBranch[]
}

model Service {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  subtitle     String?
  description  String
  price_bob    Int
  duration_min Int?
  image_url    String?
  is_featured  Boolean  @default(false)
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now())
  branches     ServiceBranch[]

  @@index([is_featured])
}

model ServiceBranch {
  service_id   String
  branch_id    String
  is_available Boolean @default(true)
  service      Service @relation(fields: [service_id], references: [id])
  branch       Branch  @relation(fields: [branch_id], references: [id])

  @@id([service_id, branch_id])
}

model Template {
  id               String   @id @default(cuid())
  name             String   @unique
  language         String
  category         String?
  body_preview     String
  variables_schema Json?
  is_active        Boolean  @default(true)
  created_at       DateTime @default(now())
  campaigns        Campaign[]
}

model Campaign {
  id                  String             @id @default(cuid())
  name                String
  template_id         String
  audience_filter     Json
  status              CampaignStatus     @default(draft)
  created_by_user_id  String?
  scheduled_for       DateTime?
  created_at          DateTime           @default(now())
  template            Template           @relation(fields: [template_id], references: [id])
  created_by_user     User?              @relation("CampaignCreatedBy", fields: [created_by_user_id], references: [id])
  messages            CampaignMessage[]

  @@index([status])
}

model CampaignMessage {
  id               String               @id @default(cuid())
  campaign_id      String
  conversation_id  String?
  wa_id            String
  phone_e164       String
  phone_number_id  String?
  status           CampaignMessageStatus @default(queued)
  error_json       Json?
  sent_at          DateTime?
  campaign         Campaign             @relation(fields: [campaign_id], references: [id])
  conversation     Conversation?        @relation(fields: [conversation_id], references: [id])

  @@index([campaign_id])
  @@index([status])
  @@index([phone_number_id])
}

model Prospect {
  id           String   @id @default(cuid())
  wa_id        String   @unique
  phone_e164   String
  display_name String?
  ci_digits    String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([created_at])
}

// ==================== META TEMPLATES ====================

model MetaTemplate {
  id                 String           @id @default(cuid())
  name               String
  meta_template_id   String?          // ID from Meta API (null if draft)
  category           TemplateCategory @default(UTILITY)
  language           String           @default("es")
  status             TemplateStatus   @default(DRAFT)
  quality_score      String?          // HIGH, MEDIUM, LOW, UNKNOWN
  components_json    Json             @default("[]")
  body_text          String?
  header_type        String?
  header_content     String?
  footer_text        String?
  buttons_json       Json?
  last_synced_at     DateTime?
  meta_response_json Json?
  rejection_reason   String?
  created_by_user_id String?
  is_deleted         Boolean          @default(false)
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt

  variable_mappings MetaTemplateVariableMapping[]
  created_by_user   User?                         @relation("MetaTemplateCreatedBy", fields: [created_by_user_id], references: [id])

  @@unique([name, language])
  @@index([status])
  @@index([is_deleted])
}

model MetaTemplateVariableMapping {
  id            String             @id @default(cuid())
  template_id   String
  var_index     Int
  display_name  String?
  source_type   VariableSourceType
  source_path   String
  default_value String?
  transform     String?

  template MetaTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@unique([template_id, var_index])
}

model TemplateWebhookLog {
  id            String   @id @default(cuid())
  event_type    String
  template_name String?
  template_id   String?
  raw_json      Json
  processed_at  DateTime @default(now())

  @@index([template_name])
  @@index([processed_at])
}

// ==================== AUDIENCES & CONTACTS ====================

model AudienceSegment {
  id                 String   @id @default(cuid())
  name               String
  description        String?
  rules_json         Json
  estimated_count    Int      @default(0)
  is_active          Boolean  @default(true)
  created_by_user_id String?
  last_synced_at     DateTime?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  created_by_user User? @relation("AudienceCreatedBy", fields: [created_by_user_id], references: [id])
  audience_tags AudienceTag[]

  @@index([is_active])
}

model AudienceAutomationSetting {
  id               String   @id @default(cuid())
  phone_number_id  String?
  enabled          Boolean  @default(false)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@index([phone_number_id])
}

model AudienceTag {
  id               String   @id @default(cuid())
  tag_id           String?
  segment_id       String
  phone_number_id  String?
  is_default       Boolean  @default(false)
  last_synced_at   DateTime?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  tag         Tag?            @relation(fields: [tag_id], references: [id])
  segment     AudienceSegment @relation(fields: [segment_id], references: [id])

  @@index([tag_id])
  @@index([segment_id])
  @@index([phone_number_id])
  @@unique([tag_id, phone_number_id])
}

model ImportedContact {
  id              String   @id @default(cuid())
  phone_e164      String
  name            String?
  city            String?
  tags_json       Json?
  source          String   @default("excel")
  source_ref      String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([phone_e164])
  @@index([source])
}

model OdooContact {
  id              String   @id @default(cuid())
  odoo_partner_id Int      @unique
  name            String
  phone_e164      String?
  phone_raw       String?
  email           String?
  vat             String?
  is_patient      Boolean  @default(false)
  odoo_patient_id Int?
  tags_json       Json?
  extra_data_json Json?
  last_synced_at  DateTime @default(now())
  created_at      DateTime @default(now())

  @@index([phone_e164])
  @@index([is_patient])
}
